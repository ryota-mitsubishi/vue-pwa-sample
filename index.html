<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Pushé€šçŸ¥ãƒ‡ãƒ¢</title>
    
    <!-- ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®çµ¶å¯¾ãƒ‘ã‚¹æŒ‡å®š -->
    <link rel="manifest" href="/vue-pwa-sample/manifest.json">
    <meta name="theme-color" content="#2196f3">
    <link rel="icon" href="/vue-pwa-sample/icon-192.png" type="image/png">
    
    <!-- PWAç”¨ãƒ¡ã‚¿ã‚¿ã‚° -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PushDemo">
    <link rel="apple-touch-icon" href="/vue-pwa-sample/icon-192.png">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2196f3;
            text-align: center;
            margin-bottom: 30px;
        }
        .control-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        button {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #1976d2;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #installBtn {
            display: none;
            background-color: #4caf50;
        }
        #installBtn:hover {
            background-color: #45a049;
        }
        #output {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
            background-color: #e3f2fd;
        }
        .debug-info {
            font-size: 12px;
            color: #666;
            margin-top: 20px;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ”” Pushé€šçŸ¥ãƒ†ã‚¹ãƒˆ</h1>

    <div class="status" id="statusMessage">
        ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–ä¸­...
    </div>

    <div class="control-group">
        <label for="delaySeconds">é€šçŸ¥é€ä¿¡ã¾ã§ã®ç§’æ•°:</label>
        <input type="number" id="delaySeconds" value="5" min="1" max="60"> ç§’
    </div>

    <div class="control-group">
        <button id="subscribeBtn" onclick="subscribe()">ğŸ”” é€šçŸ¥ã‚’è³¼èª­</button>
        <button id="sendBtn" onclick="sendDelayedNotification()">ğŸ“© é€šçŸ¥ã‚’é€ä¿¡ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰</button>
        <button id="testBtn" onclick="sendTestNotification()">ğŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥</button>
        <button id="installBtn">ğŸ“² ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
    </div>

    <div class="control-group">
        <label>è³¼èª­æƒ…å ±:</label>
        <pre id="output">ã¾ã è³¼èª­ã•ã‚Œã¦ã„ã¾ã›ã‚“</pre>
    </div>

    <div class="debug-info">
        <h4>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</h4>
        <div id="debugInfo">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="debug-info">
        <h4>æ³¨æ„äº‹é …:</h4>
        <ul>
            <li>GitHub Pagesã§ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å‡¦ç†ãŒã§ããªã„ãŸã‚ã€å®Ÿéš›ã®ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡ã¯åˆ¶é™ã•ã‚Œã¾ã™</li>
            <li>ã€Œãƒ†ã‚¹ãƒˆé€šçŸ¥ã€ãƒœã‚¿ãƒ³ã¯Service WorkerçµŒç”±ã§ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã™</li>
            <li>å®Œå…¨ãªæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ç’°å¢ƒãŒå¿…è¦ã§ã™</li>
        </ul>
    </div>
</div>

<script>
const vapidPublicKey = 'BHMLj0JRh9dR1W8fR5GrlPyTHbHt7vohRhArEqGfXfDANtFZCIusKt27lgtTVt2ryj0IFc3rlNMt8UatZEEvnEg';
let subscription = null;
let deferredPrompt = null;
let serviceWorkerRegistration = null;

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
    return new Uint8Array([...window.atob(base64)].map(c => c.charCodeAt(0)));
}

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
function updateDebugInfo() {
    const debugInfo = document.getElementById('debugInfo');
    debugInfo.innerHTML = `
        <strong>URL:</strong> ${window.location.href}<br>
        <strong>User Agent:</strong> ${navigator.userAgent}<br>
        <strong>Service Workerå¯¾å¿œ:</strong> ${'serviceWorker' in navigator ? 'âœ…' : 'âŒ'}<br>
        <strong>Pushé€šçŸ¥å¯¾å¿œ:</strong> ${'PushManager' in window ? 'âœ…' : 'âŒ'}<br>
        <strong>é€šçŸ¥è¨±å¯çŠ¶æ…‹:</strong> ${Notification.permission}<br>
        <strong>æ¥ç¶š:</strong> ${location.protocol === 'https:' ? 'HTTPS âœ…' : 'HTTP âš ï¸'}<br>
        <strong>ãƒ›ã‚¹ãƒˆ:</strong> ${location.hostname}
    `;
}

function updateStatus(message, type = 'info') {
    const statusElement = document.getElementById('statusMessage');
    statusElement.innerHTML = message;
    
    // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
    statusElement.classList.remove('warning', 'success', 'error');
    
    if (type === 'warning') {
        statusElement.classList.add('warning');
    } else if (type === 'success') {
        statusElement.classList.add('success');
    } else if (type === 'error') {
        statusElement.classList.add('error');
    }
}

async function subscribe() {
    try {
        updateStatus('ğŸ”„ Service Workerã‚’ç™»éŒ²ä¸­...', 'info');
        
        // Service Workerã®ç™»éŒ²
        if (!serviceWorkerRegistration) {
            serviceWorkerRegistration = await navigator.serviceWorker.register('/vue-pwa-sample/service-worker.js');
            console.log('âœ… Service Worker registered:', serviceWorkerRegistration);
        }
        
        updateStatus('ğŸ”” é€šçŸ¥è¨±å¯ã‚’ç¢ºèªä¸­...', 'info');
        
        // é€šçŸ¥è¨±å¯ã®å–å¾—
        const permission = await Notification.requestPermission();
        console.log('é€šçŸ¥è¨±å¯çŠ¶æ…‹:', permission);
        
        if (permission !== 'granted') {
            updateStatus('âŒ é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            alert('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        updateStatus('ğŸ“ ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’è³¼èª­ä¸­...', 'info');
        
        // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è³¼èª­
        subscription = await serviceWorkerRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
        });
        
        console.log('âœ… Push subscription:', subscription);
        document.getElementById('output').textContent = JSON.stringify(subscription, null, 2);
        updateStatus('âœ… ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è³¼èª­ã«æˆåŠŸã—ã¾ã—ãŸï¼', 'success');
        
        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        document.getElementById('subscribeBtn').textContent = 'âœ… è³¼èª­æ¸ˆã¿';
        document.getElementById('subscribeBtn').disabled = true;
        
    } catch (error) {
        console.error('âŒ è³¼èª­ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
    }
}

// å¼·åŒ–ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆé€šçŸ¥é–¢æ•°ï¼ˆæ—¢å­˜ã®sendTestNotificationé–¢æ•°ã‚’ç½®ãæ›ãˆï¼‰
async function sendTestNotification() {
    if (!subscription) {
        alert("ğŸ“© ã¾ãšé€šçŸ¥ã‚’è³¼èª­ã—ã¦ãã ã•ã„ï¼");
        return;
    }

    const delay = parseInt(document.getElementById('delaySeconds').value) || 5;
    
    updateStatus(`â±ï¸ ${delay}ç§’å¾Œã«å¼·åŒ–ã•ã‚ŒãŸé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™...`, 'info');
    
    setTimeout(async () => {
        try {
            if (serviceWorkerRegistration) {
                // ã‚ˆã‚Šç›®ç«‹ã¤é€šçŸ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const notificationData = {
                    title: `ğŸš¨ ${delay}ç§’å¾Œã®é‡è¦é€šçŸ¥ï¼`,
                    body: `ğŸ“² ã“ã®é€šçŸ¥ã¯${delay}ç§’å¾Œã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚\nğŸ”” ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨éŸ³ã§é€šçŸ¥ã—ã¾ã™ï¼`,
                    urgency: 'high'
                };
                
                await serviceWorkerRegistration.showNotification(notificationData.title, {
                    body: notificationData.body,
                    icon: '/vue-pwa-sample/icon-192.png',
                    badge: '/vue-pwa-sample/icon-192.png',
                    tag: 'enhanced-notification-' + Date.now(),
                    
                    // è¦–èªæ€§ã‚’æœ€å¤§åŒ–
                    requireInteraction: true,
                    silent: false,
                    vibrate: [300, 100, 300, 100, 300], // ã‚ˆã‚Šé•·ã„ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    urgency: 'high',
                    
                    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
                    actions: [
                        {
                            action: 'open',
                            title: 'ğŸ“± ã‚¢ãƒ—ãƒªã‚’é–‹ã',
                            icon: '/vue-pwa-sample/icon-192.png'
                        },
                        {
                            action: 'snooze',
                            title: 'â° å¾Œã§é€šçŸ¥',
                            icon: '/vue-pwa-sample/icon-192.png'
                        }
                    ],
                    
                    data: {
                        url: '/vue-pwa-sample/',
                        timestamp: Date.now(),
                        urgency: 'high'
                    }
                });
                
                updateStatus('âœ… å¼·åŒ–ã•ã‚ŒãŸé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
            }
        } catch (error) {
            console.error('é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            updateStatus(`âŒ é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        }
    }, delay * 1000);
}

function sendDelayedNotification() {
    if (!subscription) {
        alert("ğŸ“© ã¾ãšé€šçŸ¥ã‚’è³¼èª­ã—ã¦ãã ã•ã„ï¼");
        return;
    }

    const delay = parseInt(document.getElementById('delaySeconds').value) || 5;
    
    // GitHub Pagesã§ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†ãŒã§ããªã„ã“ã¨ã‚’èª¬æ˜
    alert(`âš ï¸ GitHub Pagesã§ã¯å®Ÿéš›ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\n\nä»£ã‚ã‚Šã«ã€Œãƒ†ã‚¹ãƒˆé€šçŸ¥ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚\n\nå®Œå…¨ãªæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Node.jsã‚„Pythonç­‰ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚`);
}

// PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨ãƒ­ã‚¸ãƒƒã‚¯
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installBtn').style.display = 'inline-block';
});

document.getElementById('installBtn').addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠ: ${outcome}`);
        deferredPrompt = null;
        document.getElementById('installBtn').style.display = 'none';
    }
});

// åˆæœŸåŒ–
window.addEventListener('load', async () => {
    updateDebugInfo();

    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        updateStatus('âš ï¸ Chromeã§ã¯HTTPSæ¥ç¶šã¾ãŸã¯localhostãŒå¿…è¦ã§ã™', 'warning');
    } else {
        updateStatus('âœ… æº–å‚™å®Œäº† - é€šçŸ¥ã‚’è³¼èª­ã—ã¦ãã ã•ã„', 'success');
    }
    
    // Service WorkerãŒæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.getRegistration();
            if (registration) {
                serviceWorkerRegistration = registration;
                console.log('æ—¢å­˜ã®Service Worker found:', registration);
            }
        } catch (error) {
            console.log('Service Worker check error:', error);
        }
    }
});

// Service Workerã®çŠ¶æ…‹å¤‰æ›´ã‚’ãƒªãƒƒã‚¹ãƒ³
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', event => {
        console.log('Service Workerã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', event.data);
    });
}

    // ä»¥ä¸‹ã®é–¢æ•°ã‚’æ—¢å­˜ã®scriptã‚¿ã‚°å†…ã«è¿½åŠ ã—ã¦ãã ã•ã„

// ç·Šæ€¥é€šçŸ¥ã®é€ä¿¡é–¢æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
async function sendUrgentNotification() {
    if (!subscription) {
        alert("ğŸ“© ã¾ãšé€šçŸ¥ã‚’è³¼èª­ã—ã¦ãã ã•ã„ï¼");
        return;
    }

    try {
        if (serviceWorkerRegistration) {
            await serviceWorkerRegistration.showNotification('ğŸš¨ ç·Šæ€¥é€šçŸ¥ï¼', {
                body: 'âš¡ ã“ã‚Œã¯ç·Šæ€¥åº¦ã®é«˜ã„é€šçŸ¥ã§ã™ï¼\nğŸ”” å³åº§ã«ç¢ºèªã—ã¦ãã ã•ã„',
                icon: '/vue-pwa-sample/icon-192.png',
                badge: '/vue-pwa-sample/icon-192.png',
                tag: 'urgent-notification-' + Date.now(),
                
                // ç·Šæ€¥åº¦æœ€å¤§è¨­å®š
                requireInteraction: true,
                silent: false,
                vibrate: [500, 200, 500, 200, 500, 200, 500], // æ¿€ã—ã„ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                urgency: 'high',
                
                // ç›®ç«‹ã¤ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
                actions: [
                    {
                        action: 'urgent_open',
                        title: 'ğŸš¨ ä»Šã™ãç¢ºèª',
                        icon: '/vue-pwa-sample/icon-192.png'
                    },
                    {
                        action: 'dismiss',
                        title: 'âŒ å´ä¸‹',
                        icon: '/vue-pwa-sample/icon-192.png'
                    }
                ],
                
                data: {
                    url: '/vue-pwa-sample/',
                    timestamp: Date.now(),
                    urgency: 'urgent',
                    type: 'emergency'
                }
            });
            
            updateStatus('ğŸš¨ ç·Šæ€¥é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
        }
    } catch (error) {
        console.error('ç·Šæ€¥é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus(`âŒ ç·Šæ€¥é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}

// é€£ç¶šé€šçŸ¥ã®é€ä¿¡é–¢æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
async function sendRepeatedNotifications() {
    if (!subscription) {
        alert("ğŸ“© ã¾ãšé€šçŸ¥ã‚’è³¼èª­ã—ã¦ãã ã•ã„ï¼");
        return;
    }

    const count = 3; // 3å›ç¹°ã‚Šè¿”ã—
    const interval = 2000; // 2ç§’é–“éš”
    
    updateStatus(`ğŸ”„ ${count}å›ã®é€£ç¶šé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™...`, 'info');

    for (let i = 1; i <= count; i++) {
        setTimeout(async () => {
            try {
                if (serviceWorkerRegistration) {
                    await serviceWorkerRegistration.showNotification(`ğŸ“¢ é€šçŸ¥ ${i}/${count}`, {
                        body: `ğŸ”” ã“ã‚Œã¯${i}å›ç›®ã®é€šçŸ¥ã§ã™ï¼ˆå…¨${count}å›ï¼‰\nğŸ“± é‡è¦ãªæƒ…å ±ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™`,
                        icon: '/vue-pwa-sample/icon-192.png',
                        badge: '/vue-pwa-sample/icon-192.png',
                        tag: 'repeated-notification-' + i + '-' + Date.now(),
                        
                        requireInteraction: i === count, // æœ€å¾Œã®é€šçŸ¥ã®ã¿æ“ä½œãŒå¿…è¦
                        silent: false,
                        vibrate: [200, 100, 200], // çŸ­ã‚ã®ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                        urgency: i === count ? 'high' : 'normal',
                        
                        actions: i === count ? [
                            {
                                action: 'complete',
                                title: 'âœ… ç¢ºèªå®Œäº†',
                                icon: '/vue-pwa-sample/icon-192.png'
                            }
                        ] : undefined,
                        
                        data: {
                            url: '/vue-pwa-sample/',
                            sequence: i,
                            total: count,
                            timestamp: Date.now()
                        }
                    });
                }
            } catch (error) {
                console.error(`é€šçŸ¥${i}é€ä¿¡ã‚¨ãƒ©ãƒ¼:`, error);
            }
        }, (i - 1) * interval);
    }
    
    setTimeout(() => {
        updateStatus('âœ… é€£ç¶šé€šçŸ¥ã®é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
    }, count * interval + 500);
}
    
</script>
</body>
</html>
